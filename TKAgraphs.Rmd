library("ggplot2")
library("dplyr")
data <- read.csv("WorkDf5.csv", sep=";")
data$MEDperMonth <- ifelse(data$TimeBefore==0, 0, data$med_load/data$TimeBefore)
data$MEDperMonth <- ifelse(data$MEDperMonth > 80000, NA, data$MEDperMonth)
datagrp <- group_by(data, TKAYear)
data$TKAYear <- as.factor(data$TKAYear)

#Graph: MEDperMonth by year 
meanMEDxYear <- summarise(datagrp, Mean_MED = mean(MEDperMonth, na.rm=T))
g <- ggplot(meanMEDxYear, aes(TKAYear, Mean_MED)) + geom_point() + geom_smooth(method = "lm", se = F) + labs(title = "Mean Preoperative Morphine Equivalents \n per Month by Year", x = "Year", y = "Mean Morphine Equivalents per Month")

medianMEDxYear <- summarise(datagrp, MEDperMonth = median(MEDperMonth, na.rm=T))
p <- ggplot(medianMEDxYear, aes(TKAYear, Median_MED)) + geom_point() + geom_smooth(method = "lm", se = F) + labs(title = "Median Preoperative Morphine Equivalents \n per Month by Year", x = "Year", y = "Median Morphine Equivalents per Month")

p <- ggplot(data, aes(TKAYear, MEDperMonth)) + geom_boxplot(outlier.shape = NA, fill="aliceblue") + coord_cartesian(ylim = c(0,875))+geom_smooth(method="lm", aes(group=1))+ labs(title = "Preoperative Opiate Use by Year", x = "Year", y = "Distribution of Morphine Equivalents per Month")

#Graph: TypeBefore by year
meanTBxYear <- summarise(datagrp, Mean_Types = mean(TypeBefore, na.rm=T))
a <- ggplot(meanTBxYear, aes(TKAYear, Mean_Types)) + geom_point() + geom_smooth(method = "lm", se = F) + labs(title = "Mean Number of Unique Opiates Prescribed \n Preoperatively by Year", x = "Year", y = "Mean Unique Opiates Prescribed")

medianTBxYear <- summarise(datagrp, Median_Types = median(TypeBefore, na.rm=T))
b <- ggplot(medianTBxYear, aes(TKAYear, Median_Types)) + geom_point() + geom_smooth(method = "lm", se = F) + labs(title = "Median Number of Unique Opiates Prescribed \n Preoperatively by Year", x = "Year", y = "Median Unique Opiates Prescribed")

#Create graphs
ppi <- 300
png("MeanMEDxYear.png", width = 6*ppi, height = 6*ppi, res = ppi)
g
dev.off()
pdf("MeanMEDxYear.pdf")
g
dev.off()
png("MedianMEDxYear.png", width = 6*ppi, height = 6*ppi, res = ppi)
p
dev.off()
pdf("MedianMEDxYear.pdf")
p
dev.off()
png("MeanTypeBeforexYear.png", width = 6*ppi, height = 6*ppi, res = ppi)
a
dev.off()
pdf("MeanTypeBeforexYear.pdf")
a
dev.off()
png("MedianTypeBeforexYear.png", width = 6*ppi, height = 6*ppi, res = ppi)
b
dev.off()
pdf("MedianTypeBeforexYear.pdf")
b
dev.off()

#Age histogram, grouped by chronic opioid use
data$chronic <- as.factor(data$chronic)
data <- rename(data, Chronic = chronic)
data$Chronic <- ifelse(data$Chronic == 1, "Yes", "No")
z <- ggplot(data, aes(x=Age, fill = Chronic)) + geom_histogram() + labs(title = "Age Distribution Grouped by Chronic \n Opiate Use", x = "Age", y = "Count")
#Save
ppi <- 300
png("AgexChronic.png", width = 6*ppi, height = 6*ppi, res = ppi)
z
dev.off()
pdf("AgexChronic.pdf")
z
dev.off()

#Revision free survival curve separated by chronic opioid use with CIs and p-value
library("survival")
library("rms")
data$RevLogical <- as.factor(data$RevLogical)
data$chronic <- ifelse(data$chronic == 1, "Chronic", "Not Chronic")
data$chronic <- as.factor(data$chronic)
data$t2rev <- ifelse(data$t2rev < 0, NA, data$t2rev)
data2 <- na.omit(data[,c(39,48,49)])
objNpsurv <- npsurv(formula = Surv(t2rev, RevLogical == 1) ~ chronic, data = data2)
pval <- chisq.test(xtabs(~chronic+RevLogical,data=data2))
lab <- paste("P-value =",format(pval[[3]],digits=3),"")
ppi <- 300
png("Survival.png", width = 6*ppi, height = 6*ppi, res = ppi)
survplot(objNpsurv, ylim = c(.9,1), xlab = "Days", ylab = "Percent of TKAs Unrevised", conf.type="log-log", levels.only=T, col.fill =c(6,5), legend.pos="right")
title(main = "Survival Curve of TKA Revision \n by Opiate Use")
text(x=2400,y=.98,labels=lab)
dev.off()
pdf("Survival.pdf")
survplot(objNpsurv, ylim = c(.9,1), xlab = "Days", ylab = "Percent of TKAs Unrevised", conf.type="log-log", levels.only=T, col.fill =c(6,5), legend.pos="right")
title(main = "Survival Curve of TKA Revision \n by Opiate Use")
text(x=2400,y=.98,labels=lab)
dev.off()

#Surface plot: x = MED/Month, y = TimeBefore, z = count
library(MASS)
library(RColorBrewer)
library(hexbin)
rf <- colorRampPalette(rev(brewer.pal(11,'Spectral')))
r <- rf(32)
data$MEDperMonth <- ifelse(data$TimeBefore==0, 0, data$med_load/data$TimeBefore)
data$MEDperMonth <- ifelse(data$MEDperMonth > 80000, NA, data$MEDperMonth)
data <- mutate(data, MEDperDay = MEDperMonth/(365/12))
data2 <- na.omit(data[,c(51,19)])
data3 <- data2[data2$TimeBefore > 2,]
p <- ggplot(data3, aes(MEDperDay,TimeBefore))
h3 <- p + stat_bin2d(bins=50) + scale_fill_gradientn(colours=r) + labs(title="Density Plot of Preop Morphine Equivalent \n Use in Chronic Users", x="Morphine Equivalents/ Day", y="Months")
h3
hexbinplot(TimeBefore ~ MEDperDay, data=data3, colramp=rf, trans=log, inv=exp)
k <- kde2d(data3[,1], data3[,2], n=200, lims=c(0,65,3,30))
filled.contour(k,color.palette=colorRampPalette(c('white','blue','yellow','red','darkred')), ylim=c(0,25), xlim=c(0,50))
ppi <- 300
png("Density.png", width = 6*ppi, height = 6*ppi, res = ppi)
image(k, col=r, ylim=c(0,30))
title(main="Density Plot of Preop Morphine Equivalent \n Use in Chronic Users", xlab = "Morphine Equivalents / Day", ylab = "Months")
dev.off()
pdf("Density.pdf")
image(k, col=r)
title(main="Density Plot of Daily Morphine Equivalents \n by Months of Preoperative Use", xlab = "MED/ Day", ylab = "Months")
dev.off()

